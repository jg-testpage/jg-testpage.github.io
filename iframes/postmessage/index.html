<!-- parent page should be loaded from
     https://jg-testpage.github.io/iframes/postmessage/index.html
     to emulate cross-site security -->
<!DOCTYPE html>
<body>
  <iframe id='test_iframe' src="https://jg-testpage.netlify.app/iframes/postmessage/iframe.html"></iframe>
  <script>
      function onPlayerEarlyMessage(event) {
        var expectedOrigin = "https://jg-testpage.netlify.app"
        var expectedMessage = 'PLAYER_HTML_OK'

        if (event.origin === expectedOrigin &&
            event.data === expectedMessage) {
          console.log('parent: got ' + expectedMessage)
          var msg = JSON.stringify({
            landingId: "42-42",
            visitId: 42,
            visitNumber: 42,
          });
          console.log('parent: sending early payload', msg)
          event.source.postMessage(msg, event.origin);
          window.removeEventListener('message', onPlayerEarlyMessage);
        }
      }

      console.log('parent: registering onmessage handler; waiting for alive info from child')
      window.addEventListener('message', onPlayerEarlyMessage)
  </script>
</body>