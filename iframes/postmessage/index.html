<!-- parent page should be loaded from
     https://jg-testpage.github.io/iframes/postmessage/index.html
     to emulate cross-site security -->
<!DOCTYPE html>
<body>
  <iframe id='test_iframe' src="https://jg-testpage.netlify.app/iframes/postmessage/iframe.html"></iframe>
  <script>
      function onPlayerEarlyMessage(event) {
        const expectedOrigin = "https://jg-testpage.netlify.app"
        if (event.origin === expectedOrigin &&
            event.data === 'PLAYER_HTML_OK') {
          console.log('parent: got PLAYER_HTML_OK')
          let msg = JSON.stringify({
            landingId: 42,
            visitId: 42,
            visitNumber: 42,
          });
          console.log('parent: sending early payload', msg)
          event.source.postMessage(msg, event.origin);
          window.removeEventListener('message', onPlayerEarlyMessage);
        }
      }

      // TODO do we have a guarantee we will exec this first, before iframe?
      // maybe player should do this in a setInterval loop until it gets the ACK?
      console.log('parent: registering')
      window.addEventListener('message', onPlayerEarlyMessage)
  </script>
</body>